# Depend APT Bot

A GitHub Action for automatically updating APT package versions in YAML configuration files.

## Features

- Fetches latest package versions from APT repositories
- Supports configurable architecture targeting (amd64, arm64, etc.)
- Uses proper Debian version comparison
- Early exit optimization for performance
- Comprehensive error handling and logging
- Outputs update status for workflow integration

## Usage

```yaml
- name: Update APT packages
  uses: ./.github/actions/depend-apt-bot
  with:
    file: 'mongo.yml'
    key: 'mongo'
  id: update-packages

- name: Check if packages were updated
  if: steps.update-packages.outputs.updated == 'true'
  run: |
    echo "Updated packages: ${{ steps.update-packages.outputs.updated-packages }}"
```

## Input YAML Format

The action expects a YAML file with the following structure:

```yaml
mongo:
  apt:
    repository: https://repo.mongodb.org/apt/ubuntu
    distribution: noble/mongodb-org/8.0
    arch: amd64
    components:
      - multiverse
    packages:
      mongodb-org: 8.0.0
      mongodb-org-database: 8.0.0
      mongodb-org-server: 8.0.0
      mongodb-mongosh: 8.0.0
```

The top-level key in the YAML file must match the `key` parameter specified in the action inputs.

## Inputs

| Input | Description | Required |
|-------|-------------|----------|
| `file` | Path to YAML file containing package configuration | Yes |
| `key` | Name of the top-level key in the YAML file | Yes |

## Outputs

| Output | Description |
|--------|-------------|
| `updated` | Whether any packages were updated (`true`/`false`) |
| `updated-packages` | JSON array of updated package names |

## Example Workflow

```yaml
name: Update Dependencies
on:
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM
  workflow_dispatch:

jobs:
  update-apt-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Update MongoDB packages
        uses: ./.github/actions/depend-apt-bot
        with:
          file: 'mongo.yml'
          key: 'mongo'
          package-manager: 'apt'
        id: update-mongo
      
      - name: Create Pull Request
        if: steps.update-mongo.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'Update APT packages'
          body: |
            Updated packages: ${{ steps.update-mongo.outputs.updated-packages }}
            
            ðŸ¤– Auto-generated by depend-apt-bot
```

## Architecture

The action efficiently processes APT package indexes by:

1. Building URLs for package index files based on repository configuration
2. Fetching and parsing package indexes with early exit optimization
3. Comparing versions using proper Debian version semantics
4. Updating only the packages specified in the input YAML file

## Development

### Running Tests

```bash
yarn test                # Run tests once
yarn run test:watch      # Run tests in watch mode
yarn run test:coverage   # Run tests with coverage report
```

### Test Structure

The test suite covers:
- URL building for package indexes
- Package entry parsing logic
- Version comparison with error handling
- Integration scenarios with real package data

## License

MIT

